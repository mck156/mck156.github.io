<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>GitHub 目录浏览 & Markdown 预览（极简版）</title>
    <style>
      :root {
        --bg: #fff;
        --fg: #111;
        --muted: #777;
        --border: #e5e5e5;
        --hover-bg: #f7f7f7;
        --code-bg: #f6f8fa;
        --btn-bg: #fafafa;
        --btn-hover: #f2f2f2;
      }
      [data-theme="dark"] {
        --bg: #1a1a1a;
        --fg: #e4e4e4;
        --muted: #a0a0a0;
        --border: #404040;
        --hover-bg: #2a2a2a;
        --code-bg: #2d2d2d;
        --btn-bg: #2a2a2a;
        --btn-hover: #333;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial, "Noto Sans SC", "Microsoft YaHei", sans-serif;
        background: var(--bg);
        color: var(--fg);
        transition: background 0.3s, color 0.3s;
      }
      header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      header .repo {
        font-weight: 700;
      }
      #app {
        display: grid;
        grid-template-columns: 320px 1fr;
        min-height: calc(100vh - 57px);
      }
      @media (max-width: 900px) {
        #app {
          grid-template-columns: 1fr;
        }
      }
      aside {
        border-right: 1px solid var(--border);
        padding: 12px;
      }
      main {
        padding: 16px;
      }
      .breadcrumb {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 8px;
        word-break: break-all;
      }
      .breadcrumb a {
        color: inherit;
        text-decoration: none;
        border-bottom: 1px dotted var(--border);
      }
      .section-title {
        font-size: 14px;
        font-weight: 700;
        margin: 12px 0 6px;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      li {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 6px;
        border-radius: 8px;
        cursor: pointer;
      }
      li:hover {
        background: var(--hover-bg);
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        width: 100%;
      }
      .name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .badge {
        border: 1px solid var(--border);
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .readme {
        border-top: 1px solid var(--border);
        margin-top: 24px;
        padding-top: 16px;
      }
      .md {
        line-height: 1.75;
      }
      .md pre {
        overflow: auto;
        background: var(--code-bg);
        padding: 12px;
        border-radius: 8px;
      }
      .md code {
        background: var(--code-bg);
        padding: 2px 4px;
        border-radius: 4px;
      }
      .empty {
        color: var(--muted);
        padding: 8px 0;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      button {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button:hover {
        background: var(--btn-hover);
      }
      #themeToggle {
        font-size: 18px;
        padding: 6px 12px;
      }
    </style>
    <!-- 轻量 Markdown 渲染：marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <header>
      <div
        class="repo"
        id="repoTitle"
      ></div>
      <div class="toolbar">
        <button
          id="themeToggle"
          title="切换主题"
        >
          🌙
        </button>
        <span class="muted">分支：</span>
        <select id="branchSelect"></select>
        <button id="homeBtn">回到根目录</button>
      </div>
    </header>

    <div id="app">
      <aside>
        <div
          class="breadcrumb"
          id="breadcrumb"
        ></div>
        <div class="section">
          <div class="section-title">当前目录</div>
          <ul id="list"></ul>
        </div>
      </aside>
      <main>
        <div
          id="content"
          class="md"
        ></div>
        <div
          id="readme"
          class="md readme"
        ></div>
      </main>
    </div>

    <script>
      // === 配置区：把下面三项改成你的仓库信息 ===
      const REPO_OWNER = "mck156"; // ← GitHub 用户名 / 组织名
      const REPO_NAME = "mck156.github.io"; // ← 仓库名
      const DEFAULT_BRANCH = "main"; // ← 分支名（常见为 main 或 master）
      // ============================================

      const state = {
        owner: REPO_OWNER,
        repo: REPO_NAME,
        branch: DEFAULT_BRANCH,
        path: "", // 当前浏览路径（相对仓库根）
      };

      const els = {
        repoTitle: document.getElementById("repoTitle"),
        list: document.getElementById("list"),
        content: document.getElementById("content"),
        readme: document.getElementById("readme"),
        breadcrumb: document.getElementById("breadcrumb"),
        branchSelect: document.getElementById("branchSelect"),
        homeBtn: document.getElementById("homeBtn"),
        themeToggle: document.getElementById("themeToggle"),
      };

      els.homeBtn.addEventListener("click", () => loadPath(""));

      // 主题切换
      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      els.themeToggle.textContent = savedTheme === "dark" ? "☀️" : "🌙";

      els.themeToggle.addEventListener("click", () => {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        els.themeToggle.textContent = newTheme === "dark" ? "☀️" : "🌙";
      });

      function setTitle() {
        els.repoTitle.textContent = `${state.owner}/${state.repo}`;
      }

      async function fetchJSON(url) {
        const res = await fetch(url, {
          headers: { "Accept": "application/vnd.github+json" },
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
        return res.json();
      }

      function joinPath(...parts) {
        return parts.filter(Boolean).join("/");
      }

      function renderBreadcrumb() {
        const parts = state.path.split("/").filter(Boolean);
        let acc = "";
        const segs = [`<a href="#" data-path="">${state.repo}</a>`];
        for (const p of parts) {
          acc = joinPath(acc, p);
          segs.push(`<span> / </span><a href="#" data-path="${acc}">${p}</a>`);
        }
        els.breadcrumb.innerHTML = segs.join("");
        els.breadcrumb.querySelectorAll("a[data-path]").forEach((a) => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            loadPath(a.getAttribute("data-path"));
          });
        });
      }

      async function loadBranches() {
        try {
          const data = await fetchJSON(
            `https://api.github.com/repos/${state.owner}/${state.repo}/branches`,
          );
          els.branchSelect.innerHTML = "";
          data.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b.name;
            opt.textContent = b.name;
            if (b.name === state.branch) opt.selected = true;
            els.branchSelect.appendChild(opt);
          });
          els.branchSelect.onchange = () => {
            state.branch = els.branchSelect.value;
            loadPath(state.path);
          };
        } catch (e) {
          console.warn("分支加载失败（使用默认分支）", e);
        }
      }

      async function loadPath(path = "") {
        state.path = path;
        setTitle();
        renderBreadcrumb();
        els.content.innerHTML = "";
        els.readme.innerHTML = "";
        els.list.innerHTML = '<li class="muted">加载中…</li>';

        try {
          const url = `https://api.github.com/repos/${state.owner}/${
            state.repo
          }/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(
            state.branch,
          )}`;
          const items = await fetchJSON(url);
          renderList(Array.isArray(items) ? items : []);

          // 首页显示 README
          if (!path) {
            await tryLoadReadme("");
          } else {
            // 子目录内如果有 README 也可显示在内容区域
            await tryLoadReadme(path);
          }
        } catch (e) {
          els.list.innerHTML = `<li class="muted">加载失败：${e.message}</li>`;
        }
      }

      function renderList(items) {
        // 目录优先、然后 Markdown、然后其他文件
        const dirs = items
          .filter((i) => i.type === "dir")
          .sort((a, b) => a.name.localeCompare(b.name));
        const mds = items
          .filter((i) => i.type === "file" && /\.md$/i.test(i.name))
          .sort((a, b) => a.name.localeCompare(b.name));
        const rest = items
          .filter((i) => i.type === "file" && !/\.md$/i.test(i.name))
          .sort((a, b) => a.name.localeCompare(b.name));

        const makeLi = (icon, name, onClick, right = "") => {
          const li = document.createElement("li");
          li.innerHTML = `<div class="row"><div class="name">${icon} ${name}</div><div class="muted">${right}</div></div>`;
          li.addEventListener("click", onClick);
          return li;
        };

        els.list.innerHTML = "";
        if (dirs.length === 0 && mds.length === 0 && rest.length === 0) {
          els.list.innerHTML = '<div class="empty">（空目录）</div>';
          return;
        }

        dirs.forEach((d) => {
          els.list.appendChild(
            makeLi("📁", d.name, () => loadPath(joinPath(state.path, d.name))),
          );
        });

        mds.forEach((f) => {
          els.list.appendChild(
            makeLi("📄", f.name, () =>
              openMarkdown(joinPath(state.path, f.name)),
            ),
          );
        });

        rest.forEach((f) => {
          const raw = `https://raw.githubusercontent.com/${state.owner}/${
            state.repo
          }/${state.branch}/${encodeURIComponent(
            joinPath(state.path, f.name),
          )}`;
          els.list.appendChild(
            makeLi(
              "📎",
              f.name,
              () => window.open(raw, "_blank"),
              f.size ? `${(f.size / 1024).toFixed(1)} KB` : "",
            ),
          );
        });
      }

      async function tryLoadReadme(path) {
        const candidates = ["README.md", "readme.md", "Readme.md"];
        for (const name of candidates) {
          try {
            const raw = await fetchRaw(joinPath(path, name));
            if (raw) {
              const html = marked.parse(raw);
              els.readme.innerHTML =
                (path ? `<h3>${name}</h3>` : `<h2>README</h2>`) + html;
              return;
            }
          } catch (_) {
            /* ignore */
          }
        }
      }

      async function fetchRaw(relPath) {
        const url = `https://raw.githubusercontent.com/${state.owner}/${
          state.repo
        }/${state.branch}/${relPath
          .split("/")
          .map(encodeURIComponent)
          .join("/")}`;
        const res = await fetch(url);
        if (res.ok) return await res.text();
        throw new Error(`HTTP ${res.status}`);
      }

      async function openMarkdown(relPath) {
        els.content.innerHTML = "加载 Markdown…";
        els.readme.innerHTML = ""; // 清空 README 区域
        try {
          const md = await fetchRaw(relPath);
          els.content.innerHTML = marked.parse(md);
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (e) {
          els.content.innerHTML = `<div class="muted">无法加载：${relPath}（${e.message}）</div>`;
        }
      }

      // 初始化
      (async function init() {
        setTitle();
        await loadBranches();
        await loadPath("");
      })();
    </script>
  </body>
</html>
